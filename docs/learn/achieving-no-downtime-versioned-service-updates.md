

[![feedback](https://www.visualstudio.com/wp-content/uploads/2017/01/feedback-button-normal.svg)](#)













[![](https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b?ver=5c31)
Microsoft](https://www.microsoft.com)



Visual
Studio



  - [Microsoft 365](https://www.microsoft.com/en-us/microsoft-365)

  - [Azure](https://azure.microsoft.com)

  - [Office 365](https://products.office.com/en-us/business/office)

  - [Dynamics 365](https://dynamics.microsoft.com/en-us/)

  - [SQL](https://www.microsoft.com/sql-server/)

  - [Windows 10](https://www.microsoft.com/en-us/windowsforbusiness)

  - 
    
    
    
    More
    
      - Products & Services
          - [Windows
            Server](https://www.microsoft.com/cloud-platform/windows-server)
          - [Enterprise Mobility +
            Security](https://www.microsoft.com/cloud-platform/enterprise-mobility-security)
          - [Power
            BI](https://powerbi.microsoft.com/en-us/)
          - [Teams](https://products.office.com/en-us/microsoft-teams/group-chat-software)
          - [Visual Studio](https://www.visualstudio.com/)
          - [Surface for
            Business](https://www.microsoft.com/en-us/surface/business/overview)
      - Emerging Technologies
          - [AI](https://www.microsoft.com/ai/)
          - [Internet of
            Things](https://www.microsoft.com/internet-of-things)
          - [Azure Cognitive
            Services](https://azure.microsoft.com/services/cognitive-services/)
          - [Quantum](https://www.microsoft.com/quantum/)
          - [Research](https://www.microsoft.com/research/)
      - Developer & IT
          - [Docs](https://docs.microsoft.com/en-us/)
          - [TechNet](https://technet.microsoft.com/en-us/ms376608.aspx)
          - [Developer Network](https://msdn.microsoft.com/en-us)
          - [Windows Dev
            Center](https://developer.microsoft.com/en-us/windows)
          - [Windows IT Pro
            Center](https://www.microsoft.com/en-us/itpro/windows)
          - [FastTrack](https://fasttrack.microsoft.com/office)
      - Partner
          - [Partner Network](https://partner.microsoft.com/)
          - [Solution
            Providers](https://www.microsoft.com/solution-providers/)
          - [Partner
            Center](https://partnercenter.microsoft.com/partner/home)
          - [Cloud
            Hosting](https://www.microsoft.com/en-us/cloudandhosting)
      - Industries
          - [Education](https://www.microsoft.com/en-us/education)
          - [Financial
            services](https://enterprise.microsoft.com/en-us)
          - [Government](https://enterprise.microsoft.com/en-us/industries/government/)
          - [Health](https://enterprise.microsoft.com/en-us/industries/health/)
          - [Manufacturing &
            resources](https://enterprise.microsoft.com/en-us/industries/discrete-manufacturing/)
          - [Retail](https://enterprise.microsoft.com/en-us/industries/retail-and-consumer-goods/)
      - Other
          - [Security](https://www.microsoft.com/security/)
          - [Licensing](https://www.microsoft.com/licensing/)
          - [AppSource](https://appsource.microsoft.com/)
          - [Azure
            Marketplace](https://azuremarketplace.microsoft.com/marketplace/)
          - [Events](https://events.microsoft.com/)
      - [View
all](https://www.microsoft.com/en-us/sitemap.aspx)
    
    













Sign
in

















[Visual Studio](https://www.visualstudio.com/) [Free
Account](https://go.microsoft.com/fwlink/?LinkId=307137&clcid=0x409&wt.mc_id=o~msft~vscom~product-vsts-nav~menu&campaign=o~msft~vscom~product-vsts-nav~menu)

[Visual Studio Team
Services](https://www.visualstudio.com/team-services/)



Features

  - [Git](https://www.visualstudio.com/team-services/git/)
  - [TFVC](https://www.visualstudio.com/team-services/tfvc/)
  - [Agile
    Tools](https://www.visualstudio.com/team-services/agile-tools/)
  - [CI/CD](https://www.visualstudio.com/team-services/continuous-integration/)
  - [All Features](https://www.visualstudio.com/team-services/features/)





Pricing

  - [VSTS](https://www.visualstudio.com/team-services/pricing/)
  - [TFS](https://www.visualstudio.com/team-services/tfs-pricing/)
  - [Feature
    Comparisons](https://www.visualstudio.com/team-services/compare-features/)





News

  - [Release
    Notes](https://www.visualstudio.com/team-services/release-notes/)
  - [Microsoft DevOps Blog](https://blogs.msdn.microsoft.com/devops/)
  - [VSTS Customer
    Stories](https://www.visualstudio.com/team-services/case-studies/)





Support

  - [VSTS](https://www.visualstudio.com/team-services/support/)
  - [Team Foundation
    Server](https://www.visualstudio.com/team-services/tfs_support/)
  - [Documentation](https://docs.microsoft.com/en-us/vsts/index)
  - [FAQ](https://www.visualstudio.com/team-services/faq/)



[Subscriber
Access](https://my.visualstudio.com/Benefits?wt.mc_id=o~msft~vscom~nav&campaign=o~msft~vscom~nav)
[Free
Account](https://go.microsoft.com/fwlink/?LinkId=307137&clcid=0x409&wt.mc_id=o~msft~vscom~product-vsts-nav~menu&campaign=o~msft~vscom~product-vsts-nav~menu)

































[Home](https://www.visualstudio.com)/Achieving
No Downtime Through Versioned Service
Updates



















# Achieving No Downtime Through Versioned Service Updates

### By Buck Hodges



#### About the author





[Facebook](https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.visualstudio.com%2Flearn%2Fachieving-no-downtime-versioned-service-updates%2F&t=Achieving%20No%20Downtime%20Through%20Versioned%20Service%20Updates "Facebook")[Twitter](https://twitter.com/share?text=Achieving%20No%20Downtime%20Through%20Versioned%20Service%20Updates&url=https%3A%2F%2Fwww.visualstudio.com%2Flearn%2Fachieving-no-downtime-versioned-service-updates%2F "Twitter")[Linkedin](https://www.linkedin.com/shareArticle?mini=true&url=https://www.visualstudio.com/learn/achieving-no-downtime-versioned-service-updates/&title=Achieving%20No%20Downtime%20Through%20Versioned%20Service%20Updates&summary=With%20on-premises%20software%20like%20Team%20Foundation%20Server%20%28TFS%29%2C%20it%20often%20means%20taking%20the%20server%20offline%20for%20updates%20and%20upgrades.%20Visual%20Studio%20Team%20Services%20%28VSTS%29%20and%20TFS%20share%20the%20same%20code-base%2C%20so%20operating%20like%20TFS%20would%20mean%20downtime.%20Downtime%20is%20a%20co "Linkedin")[Email](mailto:?subject=Achieving%20No%20Downtime%20Through%20Versioned%20Service%20Updates&body=https://www.visualstudio.com/learn/achieving-no-downtime-versioned-service-updates/ "Email")



















With on-premises software like Team Foundation Server (TFS), it often
means taking the server offline for updates and upgrades. Visual Studio
Team Services (VSTS) and TFS share the same code-base, so operating like
TFS would mean downtime. Downtime is a complete nonstarter for global
24×7 service. VSTS is a critical dependency for our customers. They
count on it in order to ship their own software. There’s never a good
time for everybody. So how did we decide to handle upgrades for
VSTS?













## Update Layers Separately

We have to be able to upgrade online. With a distributed online service
in multiple datacenters and separate data storage, not everything can
change simultaneously. If you broadly split the VSTS service into
application code and databases, which are versioned independently of
each other, one of those needs to absorb the complexity of handling
versioning.

We chose to handle it in the application code. VSTS and TFS have a lot
of SQL in the databases. Lots of IF statements are possible with SQL,
but never fun. So instead of further complicating our SQL, we handle
this complexity in our application code. Specifically, we created a set
of factory classes that understand the SQL versioning.

Every sprint we create a new interface with that version. That way
there’s always code that matches each database version. This allows
for easy rollback of binaries during deployment. The first thing we do
is deploy the binaries. If we deploy the new binaries and something goes
wrong, we can very quickly roll back binaries. After we deploy the
binaries, we kick off the database servicing.

So how does this actually work? Let’s say we’re currently deploying
Sprint 123. The binaries understand Sprint 123 database schema and they
understand Sprint 122 schema. The general pattern is to work with both
versions (sprints) N and N-1 of the SQL Schema. The binaries query the
database, determine what schema version they are talking to, and then
load the appropriate binding. Then, the application code handles the
case when the new data schema is not yet available. Once the new version
is available, the application code can start making use of the new
functionality that is enabled by the latest database version.

## Roll Forward Only with Data Tier

Once we upgrade the databases, we’re in a roll-forward situation if we
encounter a problem. Online database migrations are pretty complex and
often multi-step – therefore rolling forward is usually the best way to
address a problem. To look at it another way, if you can’t get upgrade
right, what leads you to believe you could get rollback right as well?
On top of that, you’d end up testing code (rollback) that you hope never
to use and would almost always be wasted work.

## Deployment Sequence

Now let’s look at how we sequence the database changes while remaining
online. For example, consider a case where we want to add a set of
columns into the database and maybe transform the data. We have to do
this invisibly to the user, which means avoiding table locks as much as
possible and then holding locks for the shortest time possible so that
it is not perceptible to the end user.

The first thing we do is to manipulate the data, possibly in parallel
tables using a SQL trigger to keep the data in sync. This also means
that large data migrations and transformations sometimes have to be
multi-step over several deployments across multiple sprints.

Once we’ve created the extra data or new schema in parallel, we go into
what we call “deployment mode” for the application code. In deployment
mode, when the code makes a call to the database, it first grabs a lock
on the schema and then releases it after running the stored procedure to
keep the database from changing between the time the call to the
database is issued and when the stored procedure runs.

The upgrade code acts as a schema writer and requests a writer lock on
the schema. The application code takes priority in taking a reader lock,
and the upgrade code sits in the background trying to acquire the writer
the lock. Under the writer lock, only a small number of very fast
operations are allowed on the tables. Then the lock is released and the
application records the new version of the database is in use and uses
the interfaces that match the new database version.

The database upgrades are all performed using a migration pattern – we
have a set of code and scripts that look at the version of the database
and then make the incremental changes to migrate the schema between from
the old to the new version. All migrations are automated and rolled out
via the Release Management service in VSTS.

We also need to update the web UI without disrupting users. When we
upgrade the Javascript files, style sheets or images, we don’t want a
mix of old and new being loaded by the client, as that can lead to
errors that could lose work in progress, such as a description you are
editing in a work item. Therefore, we version all the Javascript, CSS
and image files by having all files associated with a deployment in a
separate, versioned folder. When the web UI makes calls back to the
application tier, it’s loading assets with a specified version. Only
when a user action results in a full page refresh does the new web UI
get loaded into the browser. This ensures that the user’s experience is
never disrupted by the upgrade.



  [Buck
Hodges](https://www.visualstudio.com/author/buckh/ "Posts by Buck Hodges")
  
2017-11-09T14:51:00+00:00








![](https://secure.gravatar.com/avatar/baad17c3a2d3ea8fffc392f9dd209426?s=130&d=mm&r=g)





### Buck Hodges

Buck Hodges is Director of Engineering for Visual Studio Team Services.
He's been a member of the team since the beginning of TFS, starting as a
developer on Team Foundation Version Control for the first version of
TFS. He's helped lead the transition of the team to the cloud and
DevOps.















  - [DevOps at
    Microsoft](https://www.visualstudio.com/learn/devops-at-microsoft/)
  - [How We Work with Visual Studio Team
    Services (VSTS)](#)
      - [Moving to Cloud
        Cadence](https://www.visualstudio.com/learn/moving-cloud-cadence/)
      - [How We Use Git at
        Microsoft](https://www.visualstudio.com/learn/use-git-microsoft/)
      - [Evolving Test Practices at
        Microsoft](https://www.visualstudio.com/learn/evolving-test-practices-microsoft/)
  - [How We Architect Visual Studio Team
    Services (VSTS)](#)
      - [From Monolith to Cloud
        Service](https://www.visualstudio.com/learn/monolith-cloud-service/)
      - [Achieving No Downtime Through
        Versioned Service
        Updates](https://www.visualstudio.com/learn/achieving-no-downtime-versioned-service-updates/)
      - [Progressive Experimentation with
        Feature
        Flags](https://www.visualstudio.com/learn/progressive-experimentation-feature-flags/)
      - [Patterns for Resiliency in the
        Cloud](https://www.visualstudio.com/learn/patterns-resiliency-cloud/)
      - [Shift Left to Make Testing Fast and
        Reliable](https://www.visualstudio.com/learn/shift-left-make-testing-fast-reliable/)
      - [Eliminating Flaky
        Tests](https://www.visualstudio.com/learn/eliminating-flaky-tests/)
      - [Shift Right to Test in
        Production](https://www.visualstudio.com/learn/shift-right-test-production/)
  - [One Engineering System at
    Microsoft](#)
      - [Moving 65,000 Microsofties to DevOps
        on the Public
        Cloud](https://www.visualstudio.com/learn/moving-65000-microsofties-devops-public-cloud/)
      - [Universal Store: Journey to
        Continuous Delivery and
        DevOps](https://www.visualstudio.com/learn/universal-store-journey-continuous-delivery-devops/)
  - [Microsoft Research on DevOps
    Productivity](#)
      - [Boosting your code reviews with
        useful
        comments](https://www.visualstudio.com/learn/boosting-code-reviews-useful-comments/)
      - [Code reviews are not (primarily) for
        finding
        bugs](https://www.visualstudio.com/learn/code-reviews-not-primarily-finding-bugs/)
      - [Code ownership and software
        quality](https://www.visualstudio.com/learn/code-ownership-software-quality/)
      - [Getting the noise out of test
        runs](https://www.visualstudio.com/learn/getting-noise-test-runs/)
      - [Improving software security with
        stack traces from bug
        reports](https://www.visualstudio.com/learn/improving-software-security-stack-traces-bug-reports/)
      - [Is 100% code coverage worth the
        cost?](https://www.visualstudio.com/learn/100-code-coverage-worth-cost/)
      - [Software testing at scale to
        increase
        velocity](https://www.visualstudio.com/learn/software-testing-scale-increase-velocity/)
      - [Test while building to maximize test
        effectiveness and minimize
        cost](https://www.visualstudio.com/learn/test-building-maximize-test-effectiveness-minimize-cost/)
      - [Using a simple code churn metric to
        find software
        bugs](https://www.visualstudio.com/learn/using-simple-code-churn-metric-find-software-bugs/)



















  - [** DevOps at Microsoft](/learn/devops-at-microsoft/)
  - [** Blog](https://blogs.msdn.microsoft.com/devops/)
  - [** Learn DevOps](/learn/what-is-devops/)
  - [![](/wp-content/uploads/2016/11/git-footer-icons-dark_2.png) Learn
    Git](/learn-git/)
  - [** Learn Agile](/agile/)
  - [** DevOps Self-Assessment](https://devopsassessment.net/)













[Visual Studio Team Services](/team-services/) provides the tools you
need to continuously deliver
value





















#### What's new

  - [Surface
    Book 2](https://www.microsoft.com/en-us/surface/devices/surface-book-2/overview)
  - [Surface
    Pro](https://www.microsoft.com/en-us/surface/devices/surface-pro/overview)
  - [Xbox One X](https://www.xbox.com/en-us/xbox-one-x)
  - [Xbox One S](https://www.xbox.com/en-us/xbox-one-s?xr=shellnav)
  - [VR & mixed
    reality](https://www.microsoft.com/en-us/store/b/virtualreality)
  - [Windows 10
    apps](https://www.microsoft.com/en-us/windows/windows-10-apps)
  - [Office
apps](https://store.office.com/en-us/appshome.aspx?)





#### Store & Support

  - [Account profile](https://account.microsoft.com/)
  - [Download Center](https://www.microsoft.com/en-us/download)
  - [Sales &
    support](https://go.microsoft.com/fwlink/p/?LinkID=824761&clcid=0x409)
  - [Returns](https://go.microsoft.com/fwlink/p/?LinkID=824764&clcid=0x409)
  - [Order tracking](https://account.microsoft.com/orders)
  - [Store
    locations](https://www.microsoft.com/en-us/store/locations/find-a-store)
  - [Support](https://support.microsoft.com/en-us)
  - [Buy online, pick up in
    store](https://www.microsoft.com/en-us/store/b/buy-online-pick-up-in-store?icid=uhf_footer_bopuis)





#### Education

  - [Microsoft in education](https://www.microsoft.com/en-us/education)
  - [Office for
    students](https://www.microsoft.com/en-us/education/products/office/default.aspx)
  - [Office 365 for
    schools](https://products.office.com/en-us/academic/compare-office-365-education-plans)
  - [Deals for students &
    educators](https://www.microsoft.com/en-us/store/b/student)
  - [Microsoft Azure in
    education](https://azure.microsoft.com/en-us/community/education/)









#### Enterprise

  - [Microsoft Azure](https://azure.microsoft.com/)
  - [Enterprise](https://enterprise.microsoft.com/en-us/)
  - [Data platform](https://www.microsoft.com/en-us/sql-server/)
  - [Find a solutions
    provider](https://www.microsoft.com/en-us/solution-providers)
  - [Microsoft partner resources](https://partner.microsoft.com/en-us/)
  - [Microsoft
    AppSource](https://go.microsoft.com/fwlink/?LinkID=808093)
  - [Manufacturing &
    resources](https://enterprise.microsoft.com/en-us/industries/discrete-manufacturing/)
  - [Financial
services](https://enterprise.microsoft.com/en-us)





#### Developer

  - [Microsoft Visual Studio](https://www.visualstudio.com/)
  - [Windows Dev Center](https://developer.microsoft.com/en-us/windows)
  - [Developer Network](https://msdn.microsoft.com/en-us)
  - [TechNet](https://technet.microsoft.com/en-us)
  - [Microsoft Virtual Academy](https://mva.microsoft.com/)
  - [Microsoft developer
    program](https://developer.microsoft.com/en-us/store/register)
  - [Channel 9](https://channel9.msdn.com/)
  - [Office Dev
Center](https://developer.microsoft.com/en-us/office)





#### Company

  - [Careers](https://careers.microsoft.com/)
  - [About Microsoft](https://www.microsoft.com/en-us/about)
  - [Company news](https://news.microsoft.com/)
  - [Privacy at Microsoft](https://privacy.microsoft.com/en-us)
  - [Investors](https://www.microsoft.com/investor/default.aspx)
  - [Diversity and
    inclusion](https://www.microsoft.com/en-us/diversity/)
  - [Accessibility](https://www.microsoft.com/en-us/accessibility/home)
  - [Security](https://www.microsoft.com/en-us/security/default.aspx)







[English (United States)](#)

  - [Contact us](https://beta.visualstudio.com/support/)
  - [Privacy &
    cookies](https://www.microsoft.com/EN-US/privacystatement/OnlineServices/Default.aspx)
  - [Terms of use](https://azure.microsoft.com/en-us/support/legal/)
  - [Trademarks](https://www.microsoft.com/trademarks)
  - [About our ads](http://choice.microsoft.com/)
  - © Microsoft 2018












